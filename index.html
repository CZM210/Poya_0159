<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨åœ‹æ‰¿ç§Ÿå±•ç¤ºç³»çµ± (ç›¸å®¹ç‰ˆ)</title>
    <style>
        body { background-color: #f4f7f6; font-family: "Microsoft JhengHei", Arial; font-size: 14px; margin: 0; padding: 15px; }
        .container { max-width: 800px; margin: 0 auto; }
        .item-card { background: white; border-radius: 8px; padding: 15px; margin-bottom: 12px; border-left: 6px solid #ccc; box-shadow: 2px 2px 5px #ddd; }
        .status-new { border-left-color: #007bff; background-color: #f0f7ff; }
        .status-remove { border-left-color: #dc3545; background-color: #fff8f8; }
        .item-title { font-weight: bold; font-size: 1.1rem; color: #222; display: block; margin-bottom: 5px; }
        .sticky-header { position: relative; background: #fff; padding: 15px; border: 1px solid #ddd; margin-bottom: 20px; }
        .form-control { width: 100%; padding: 8px; margin-bottom: 10px; box-sizing: border-box; }
        .badge { display: inline-block; padding: 3px 8px; color: white; border-radius: 4px; font-size: 12px; float: right; }
        .bg-primary { background-color: #007bff; }
        .bg-danger { background-color: #dc3545; }
        .bg-secondary { background-color: #6c757d; }
        #loading-ui { display:none; text-align:center; padding: 20px; color: #007bff; }
    </style>
</head>
<body>
<div class="container">
    <div class="sticky-header">
        <h2 style="text-align:center;">ğŸª å…¨åœ‹æ‰¿ç§Ÿç³»çµ±</h2>
        <select id="f-store" class="form-control" onchange="fetchStoreData()"></select>
        <div id="filter-group" style="display:none;">
            <select id="f-dept" class="form-control" onchange="render()"></select>
            <select id="f-item" class="form-control" onchange="render()"></select>
            <input type="text" id="f-search" class="form-control" placeholder="æœå°‹é—œéµå­—..." onkeyup="render()">
        </div>
    </div>
    <div id="loading-ui">â³ æ­£åœ¨è¼‰å…¥è³‡æ–™ï¼Œè«‹ç¨å€™...</div>
    <div id="card-container"></div>
</div>

<script>
    var currentData = [];

    // å‚³çµ± AJAX å‡½å¼ (æ›¿ä»£ fetch)
    function ajaxGet(url, callback) {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', url, true);
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4 && xhr.status === 200) {
                callback(JSON.parse(xhr.responseText));
            }
        };
        xhr.send();
    }

    // 1. åˆå§‹åŒ–
    window.onload = function() {
        ajaxGet('data/stores.json', function(list) {
            var html = '<option value="">--- è«‹é¸æ“‡åˆ†åº— ---</option>';
            for (var i = 0; i < list.length; i++) {
                html += '<option value="' + list[i].id + '">' + list[i].id + ' ' + list[i].name + '</option>';
            }
            document.getElementById('f-store').innerHTML = html;
        });
    };

    // 2. æŠ“å–åˆ†åº—è³‡æ–™
    function fetchStoreData() {
        var sid = document.getElementById('f-store').value;
        if (!sid) {
            document.getElementById('filter-group').style.display = 'none';
            document.getElementById('card-container').innerHTML = '';
            return;
        }

        document.getElementById('loading-ui').style.display = 'block';
        ajaxGet('data/' + sid + '.json', function(data) {
            currentData = data;
            document.getElementById('loading-ui').style.display = 'none';
            document.getElementById('filter-group').style.display = 'block';

            // æ›´æ–°é¸å–® (æ‰‹å‹•æ’é™¤é‡è¤‡èˆ‡æ’åº)
            var depts = [];
            var items = [];
            for (var i = 0; i < data.length; i++) {
                if (data[i].éƒ¨é–€ && depts.indexOf(data[i].éƒ¨é–€) === -1) depts.push(data[i].éƒ¨é–€);
                if (data[i].é …ç›® && items.indexOf(data[i].é …ç›®) === -1) items.push(data[i].é …ç›®);
            }
            depts.sort();
            items.sort();

            var deptHtml = '<option value="">-- å…¨éƒ¨éƒ¨é–€ --</option>';
            for (var j = 0; j < depts.length; j++) {
                deptHtml += '<option value="' + depts[j] + '">' + depts[j] + '</option>';
            }
            deptHtml += '<option value="FN">â­ åªçœ‹æ–°å¢</option><option value="FR">âŒ åªçœ‹ç§»é™¤</option>';
            document.getElementById('f-dept').innerHTML = deptHtml;

            var itemHtml = '<option value="">-- æ‰€æœ‰é …ç›® --</option>';
            for (var k = 0; k < items.length; k++) {
                itemHtml += '<option value="' + items[k] + '">' + items[k] + '</option>';
            }
            document.getElementById('f-item').innerHTML = itemHtml;

            render();
        });
    }

    // 3. æ¸²æŸ“
    function render() {
        var dVal = document.getElementById('f-dept').value;
        var iVal = document.getElementById('f-item').value;
        var sVal = document.getElementById('f-search').value.toLowerCase();
        var html = '';

        for (var i = 0; i < currentData.length; i++) {
            var d = currentData[i];
            
            // éæ¿¾é‚è¼¯
            var matchDept = (dVal === "FN") ? (d.æ¯”å°çµæœ === "æ–°å¢") :
                            (dVal === "FR") ? (d.æ¯”å°çµæœ === "ç§»é™¤") :
                            (dVal === "" || d.éƒ¨é–€ === dVal);
            var matchItem = (iVal === "" || d.é …ç›® === iVal);
            var matchSearch = (d.æ‰¿ç§Ÿé …ç›® + d.å» å•†åç¨± + d.å» ç·¨).toLowerCase().indexOf(sVal) !== -1;

            if (matchDept && matchItem && matchSearch) {
                var isNew = (d.æ¯”å°çµæœ === "æ–°å¢");
                var isRem = (d.æ¯”å°çµæœ === "ç§»é™¤");
                var cssClass = isNew ? "status-new" : (isRem ? "status-remove" : "");
                var badgeClass = isNew ? "bg-primary" : (isRem ? "bg-danger" : "bg-secondary");
                
                html += '<div class="item-card ' + cssClass + '">';
                html += '  <span class="badge ' + badgeClass + '">' + d.æ¯”å°çµæœ + '</span>';
                html += '  <span class="item-title">' + (isNew ? "â­ " : (isRem ? "ğŸš« " : "")) + d.æ‰¿ç§Ÿé …ç›® + '</span>';
                html += '  <div>' + d.éƒ¨é–€ + ' | ' + d.é …ç›® + ' | ' + d.å» å•†åç¨± + '</div>';
                html += '  <div style="font-size:0.8rem; color:#888;">' + d.æª”æœŸ + ' (' + d.æª”æœŸèªªæ˜ + ')</div>';
                
                var sim = parseFloat(d['ç›¸ä¼¼åº¦ä¸å«æ‹¬å¼§']) || 0;
                if (sim >= 0.8 && sim < 1 && d.æ¯”å°åç¨±) {
                    html += '<div style="color:#FF4500; font-weight:bold; border-top:1px dashed #ddd; margin-top:5px; padding-top:5px;">ğŸ” åŸé …ç›®ï¼š' + d.æ¯”å°åç¨± + '</div>';
                }
                html += '</div>';
            }
        }
        document.getElementById('card-container').innerHTML = html;
    }
</script>
</body>
</html>